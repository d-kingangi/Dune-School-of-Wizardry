-- block_date
-- daily_amount_usd
-- previous_day_amount_usd
-- deviation

WITH
  daily_amounts AS (
    SELECT
      block_date,
      SUM(amount_usd) AS daily_amount_usd
    FROM
      curvefi.trades
    GROUP BY
      block_date
  ),
  daily_deviation AS (
    SELECT
      block_date,
      daily_amount_usd,
      LAG(daily_amount_usd, 1) OVER (
        ORDER BY
          block_date
      ) AS previous_day_amount_usd,
      daily_amount_usd - LAG(daily_amount_usd, 1) OVER (
        ORDER BY
          block_date
      ) AS deviation
    FROM
      daily_amounts
  )
SELECT
  block_date,
  daily_amount_usd,
  previous_day_amount_usd,
  deviation
FROM
  daily_deviation
ORDER BY
  block_date;



2020-02-10
2.006381794379516
2020-02-11
19011.617819166353
2.006381794379516
19009.611437371972
2020-02-12
208975.58256226173
19011.617819166353
189963.96474309536
2020-02-13
390268.87167788536
208975.58256226173
181293.28911562363
2020-02-14
907043.5431450141
390268.87167788536
516774.67146712873
2020-02-15
757251.2064196579
907043.5431450141
-149792.33672535617
2020-02-16
417152.4433969801
757251.2064196579
-340098.7630226778
2020-02-17
495930.33743966947
417152.4433969801
78777.89404268935
2020-02-18
831163.9171348682
495930.33743966947
335233.57969519874
2020-02-19
1295910.9558088353
831163.9171348682
464747.0386739671
2020-02-20
351297.95094964013
1295910.9558088353
-944613.0048591952
2020-02-21
164696.74151580167
351297.95094964013
-186601.20943383846
2020-02-22
238163.11664126077
164696.74151580167
73466.3751254591
2020-02-23
196274.21736845377
238163.11664126077
-41888.899272807
2020-02-24
213235.48341043276
196274.21736845377
16961.26604197899
2020-02-25
192056.29466146126
213235.48341043276
-21179.1887489715
2020-02-26
401405.8521576626
192056.29466146126
209349.55749620136
2020-02-27
59591.392090564805
401405.8521576626
-341814.4600670978
2020-02-28
1337872.8617137515
59591.392090564805
1278281.4696231866
2020-02-29
602515.0530889607
1337872.8617137515
-735357.8086247907
2020-03-01
2070246.1139526386
602515.0530889607
1467731.0608636779
2020-03-02
1869624.1406404981
2070246.1139526386
-200621.97331214044
2020-03-03
1576796.7656745997
1869624.1406404981
-292827.37496589846
2020-03-04
987168.9269378339
1576796.7656745997
-589627.8387367658
2020-03-05
431925.3263584919
987168.9269378339
-555243.600579342
